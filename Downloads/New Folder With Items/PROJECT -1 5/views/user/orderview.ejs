<%- include("../layouts/userpartials/header.ejs") %>

<main>
  <style>
    body {
  font-family: Arial, sans-serif;
  line-height: 1.6;
  
}

.container {
  width: 80%;
  margin: 0 auto;
  padding: 2rem;
}

h1, h2, h3 {
  margin-bottom: 0.5rem;
}

.return-details {
  border: 1px solid #ddd;
  padding: 1rem;
  margin-top: 1rem;
}

.return-details p {
  margin-bottom: 0.5rem;
}

.return-details h3 {
  margin-bottom: 0.3rem;
}

.return-details span {
  font-weight: bold;
}
    body {
  font-family: Arial, sans-serif;
  line-height: 1.6;
}

.container {
  width: 80%;
  margin: 0 auto;
  padding: 2rem;
}

.order-details {
  border: 1px solid #ddd;
  padding: 1rem;
  margin-bottom: 1rem;
}

.payment-details {
  margin-top: 1rem;
  border-top: 1px solid #ddd;
  padding-top: 1rem;
}

.delivery-details {
  margin-top: 1rem;
  border-top: 1px solid #ddd;
  padding-top: 1rem;
}

.return-information {
  border: 1px solid #ddd;
  padding: 1rem;
}

h1 {
  text-align: center;
  margin-bottom: 1rem;
}

.order-details p {
  margin-bottom: 0.3rem;
}
#rtn-btn{
color: rgb(38, 38, 219);
background-color: transparent;
border: none;
}
#cnl-btn{
border: none;
background-color: transparent;
}
.payment-details p,
.delivery-details p {
  margin-bottom: 0.5rem;
}

  </style>
    <div class="mb-4 pb-4"></div>
    <section class="shop-checkout container">
        <h2 class="page-title">Order Details</h2>
        <div class="checkout-steps"></div>
            <div class="checkout-form">
                <div class="billing-info__wrapper">
                  
                    <div class="row">
                        <div class="col-md-12">
                            <div class="col-md-12">
                              
                            <% if(orderdata){ %>
                              <% orderdata.product.forEach(value => { %>
                               
                                <div class="return-details" class="col-md-12">
                                  <% if(value.status !== 'cancelled' && value.status !== 'delivered' && value.status !== 'Return Approved' && value.status !== 'shipped' && value.status !== 'out for delivery' && value.status !== 'Waiting for Approval' && value.status !== 'pending') { %>
                                 <p>Action :  <button id="cnl-btn"><u style="color: rgb(189, 0, 0);" onclick="cancelorder('<%= value._id %>')">cancel</u></p></a></button>
                                  <input type="hidden" id="cancelOrderId" name="orderId" value="<%= orderdata._id %>">
                                  <%}%>
                                  <% if(value.status === 'delivered'){ %>
                                    <!-- <a href="" onclick="modalshow()"><p>Action : <u style="color: rgb(12, 74, 200);" >Return</u></p></a> -->
                                    <p>Action: <button id="rtn-btn" onclick="modalshow()">Return</button></p>

                                    <% } %>
                                  <p><a href="">Status : <strong><%= value.status %></strong> </a></p>
                                  <p>Order ID : <span> #<%= orderdata._id %></span></p>
                                    <img src="/public/uploadImg/<%= value.productId.Image[0] %>" width="150" height="150" alt="">
                            
                                   
                                   <br>
                                   <br>
                                  
                                    <p> <strong>Product Name : </strong><%= value.name %></p>
                                    <p><strong>Price :  </strong>₹<%= value.price %></p>
                                    <p><strong>Qty</strong> : <%= value.quantity %></h6>
                                    <p><strong>Total</strong> :  <span>₹</span><%= value.price * value.quantity %></p>
                                  
                                </div>
                                <%}) %>
                             <% } %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="checkout__totals-wrapper">
                    <div class="sticky-content">
                        <div class="checkout__totals">
                          <h4>BILLING DETAILS</h4>
                            <table class="checkout-cart-items">
                                <thead>
                                    <p>  <strong>Order placed on :  <%=
                                       orderdata.Date.toLocaleDateString('en-US', {
                                          year: 'numeric',
                                          month: 'long',
                                          day: 'numeric',
                                        });
                                        %></strong></p>
                                    <p>  <strong>Paid by <%= orderdata.paymentMethod %> </strong></p>
                                    <div class="payment-details">
                                        <p><strong>Order Amount:  ₹ <%= orderdata.subtotal %> </strong></p>
                                        <p><strong>Delivery :   ₹0</strong></p>
                                        <p> <strong>Order SubTotal:₹<%= orderdata.subtotal %></p>
                                        <p>Order Status: <strong> <%= orderdata.status %></strong></p>

                                    </div>
                                    <p>Payment Mode: <%= orderdata.paymentMethod %></p>
                                    <div class="delivery-details">
<% orderdata.deliveryDetails.forEach((order)=>{ %>

                                        <p>Deliver to: <%= order.fname %> <%=  order.lname%> </p>
                                        <p>Name : <%= order.fname %></p>
                                        <p> Address : <%= order.address %></p>
                                        <p>City : <%= order.city %></p>
                                        <p> PIN : <%= order.pin %></p>
                                        <p>Phone : <%= order.mobile %> </p>

                                        <% })%>
                                    </div>
                                </div>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div>
        <div class="modal fade" id="staticBackdrop" style="display: none;" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Return Request</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="col-md-12">
                    <div class="mt-3">
                        <select class="form-select" name="reason" id="ReturnReason">
                          <option value="" disabled selected>Select a reason for returning</option>
                          <option value="Defective Product">Defective Product</option>
                          <option value="Received Wrong Size/Colour">Received Wrong Size/Colour</option>
                          <option value="changed My mind">Changed My mind</option>
                          <option value="other">Other</option>
                        </select>
                        <textarea class="form-control form-control_gray mt-3"  name="other_reason" id="OtherReason" placeholder="Enter details if 'Other' selected" cols="30" rows="4" style="display: none;"></textarea>
                      </div>
                </div>
              </div>
              <div class="modal-footer">
                <% orderdata.product.forEach((value) => { %>
                  <% if (value && value._id) { %> 
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <input type="hidden" id="returnOrderId" name="orderId" value="<%= orderdata._id %>">

                <button type="button" class="btn btn-primary" onclick="returnOrder('<%= value._id %>','<%= orderdata._id %>')">Submit</button>
                   <% } %>
                <%}) %>
              </div>
            </div>
          </div>
        </div>
    </section>
</main>

  <script src="/public/js/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- Include jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- Include Bootstrap JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
 function modalshow() {
    $('#staticBackdrop').modal('show');

}

  </script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const returnReasonSelect = document.getElementById("ReturnReason");
    const otherReasonTextarea = document.getElementById("OtherReason");
  
    returnReasonSelect.addEventListener("change", function() {
      if (returnReasonSelect.value === "other") {
        otherReasonTextarea.style.display = "block";
      } else {
        otherReasonTextarea.style.display = "none";
      }
    });
  });
  </script>
  <script>
    const cancelorder = async (proid) => {
  try {
    const orderId = document.getElementById('cancelOrderId').value;
    console.log("the order id is getting", proid, orderId);
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "Do you want to cancel this order?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: "Confirm",
      cancelButtonText: "Cancel",
      reverseButtons: true,
    });

    if (result.isConfirmed) {
      const response = await fetch("/cancelorder", {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
                        orderId: orderId, 
                        productId: proid 
                    })
      });

      if (response.ok) {
        const responseData = await response.json(); // Fix here: response instead of res
        if (responseData.success) {
          Swal.fire('Cancelled!', 'Your order has been cancelled.', 'success')
            .then(() => {
              console.log("order cancelled successfully");
              location.reload();
            });
        } else {
          Swal.fire('Error!', 'Failed to cancel order.', 'error');
          console.log("order cancel failed");
        }
      } else {
        Swal.fire('Error!', `HTTP error: ${response.status}`, 'error');
        console.log("error occurred", response.status);
      }
    }
  } catch (error) {
    console.error("Error occurred:", error);
  }
}

 

   
   function returnOrder(proid,) {
    const returnReason = document.getElementById('ReturnReason').value;

  
    console.log(returnReason,"reason")
    const orderId = document.getElementById('returnOrderId').value;
    console.log("the order id is getting", proid, orderId);
    $('#staticBackdrop').modal('hide');
    Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, Do it!",
        cancelButtonText: "Cancel",
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/return', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: orderId, 
                        productId: proid ,
                        Reason:returnReason,
                        
                    })
                })
                .then((response) => response.json())
                .then((response) => {
                    if (response.datelimit) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Return Date expired'
                        })
                    } else if (response.return) {
                        location.reload();
                    }
                })
                .catch((error) => {
                    console.error("error occurred in fetch:", error.message)
                })
        }
    })
}

   </script>
  
<%- include("../layouts/userpartials/footer.ejs") %>